#!/bin/bash

# Clone a github repo OWNER/REPO or https://github.com/OWNER/REPO into ~/src/REPO if it doesn't already
# exist. Add the repo to the emacs project list.

set -eo pipefail

SRC_DIR="$HOME/src"

fatal() {
  echo "$@" >&2
  exit 1
}

main() {
  local repo_url owner_repo repo repo_dir

  repo_url="$1"
  repo_dir="$2"

  owner="$(awk -F/ '{print $(NF-1)}' <<<"$repo_url")"
  repo="$(awk -F/ '{print $NF}' <<<"$repo_url")"

  owner_repo="$owner/$repo"

  if [[ -z "$owner" || -z "$repo" ]]; then
    fatal "you must specify repo as OWNER/REPO or https://github.com/OWNER/REPO"
  fi

  if [[ -z "$repo_dir" ]]; then
    repo_dir="$SRC_DIR/$repo"
  fi

  if [[ -d "$repo_dir" ]]; then
    fatal "repo dir already exists: $repo_dir"
  fi

  git clone "git@github.com:$owner_repo.git" "$repo_dir"
  emacsclient -e "(project-remember-projects-under \"$repo_dir\")"
}

main "$@"
